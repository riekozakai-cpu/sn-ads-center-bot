# OpenAI APIキー申請 - セキュリティ質問への回答

## 申請概要

**プロジェクト名**: 社内問い合わせ対応Slackbot
**現状**: GPTsで稼働中のシステムをSlackbotへ移行
**目的**: Slack上での社内問い合わせ対応の効率化

---

## Q1: 具体的に使っているRAGサービスはどれですか？社内のものですか？

### 回答

**社内独自実装のRAGシステム**を構築します。

#### システム構成

| コンポーネント | 選定内容 | 管理主体 |
|--------------|---------|---------|
| **ベクトルDB** | PostgreSQL + pgvector（第一候補）<br>または Pinecone | 社内管理<br>または 外部SaaS |
| **データソース** | Notion API（社内ナレッジ）<br>+ 過去の質問・回答履歴 | 社内管理 |
| **埋め込みモデル** | OpenAI Embeddings API<br>(text-embedding-3-small) | 外部API |
| **実装場所** | Next.js APIルート | 社内管理 |

#### RAGの動作フロー

```
1. ユーザー質問受信（Slack）
   ↓
2. 質問文の埋め込みベクトル生成（OpenAI Embeddings API）
   ↓
3. ベクトルDBから類似の過去ログを検索
   ↓
4. Notion APIから関連する社内ドキュメントを検索
   ↓
5. 検索結果をコンテキストとしてOpenAI APIに送信
   ↓
6. GPT-4o-miniが社内情報を参照して応答生成
   ↓
7. Slackに返信
```

**結論**: 社内のものです（Next.js上で独自実装）

---

## Q2: PIマスクについて

### 回答

#### PIマスク処理の実装方針

**実装状況**: 現在未実装 → フェーズ2で必須実装予定

#### マスク対象の個人情報

- 氏名（個人名、顧客名）
- メールアドレス
- 電話番号
- 住所
- クレジットカード情報
- マイナンバー
- その他識別可能な個人情報

#### マスク処理のタイミング

| タイミング | 処理内容 | 例 |
|----------|---------|---|
| **①受信時**<br>（OpenAI送信前） | PIを仮IDに置換 | "田中太郎さんの契約"<br>→ "[PERSON_001]さんの契約" |
| **②送信前**<br>（OpenAI API） | マスク済みテキストを送信 | "[PERSON_001]さんの契約について教えてください" |
| **③応答受信時**<br>（Slack返信前） | 仮IDを元のPIに復元 | "[PERSON_001]さんの契約は..."<br>→ "田中太郎さんの契約は..." |

#### マスク実装方法

```typescript
// 実装予定の処理フロー
1. 正規表現によるパターンマッチング
   - メール: /[\w\.-]+@[\w\.-]+\.\w+/g
   - 電話: /0\d{1,4}-\d{1,4}-\d{4}/g

2. NER（固有表現認識）による人名検出
   - ライブラリ候補: @microsoft/presidio, 独自実装

3. セッション内でマッピング保持
   - {sessionId: {PERSON_001: "田中太郎"}}

4. セッション終了後、マッピング破棄
```

#### Notion APIから取得したデータのPIマスク

**追加のPIマスク処理**:
- Notion APIから取得した社内ドキュメントにPIが含まれる場合
- 同様にマスク処理を適用してからOpenAIに送信
- ベクトルDBに保存する履歴データもマスク済みで保存

#### PIマスクの多段防御

| データソース | マスク処理 |
|-----------|---------|
| ユーザー入力（Slack） | ✅ マスク処理 |
| Notion API取得データ | ✅ マスク処理 |
| 過去ログ（ベクトルDB） | ✅ マスク済みで保存 |
| OpenAI送信データ | ✅ マスク済み |
| OpenAI応答データ | ✅ 復元処理 |

**結論**: 現在未実装だが、OpenAI送信前・Notion取得時の2箇所でPIマスクを実装予定

---

## Q3: 内部データと外部データの組み合わせ、アクションの起動について

### 回答

#### データフロー全体像

```
[内部データ: Notion]
   ├─ 社内ナレッジベース
   ├─ FAQ
   └─ マニュアル
        ↓ マスク処理後
      [コンテキスト]
        ↓
[ユーザー質問] ─→ [マスク処理] ─→ [プロンプト生成]
                                    ↓
                            [OpenAI API]
                            GPT-4o-mini
                                    ↓
                            [AI応答生成]
                                    ↓
                            [PI復元処理]
                                    ↓
                            [Slack返信]

[外部データ: OpenAI]
   └─ GPT-4o-miniの学習データ（2023年10月時点）
```

#### 内部データと外部データの組み合わせ方法

**RAGパターン（Retrieval-Augmented Generation）**:

1. **内部データ（Notion）の利用**
   - Notion APIで関連ドキュメントを検索
   - マスク処理後、プロンプトに含める
   - 例: `以下の社内情報を参考に回答してください:\n${notionData}`

2. **外部データ（OpenAI）の利用**
   - GPT-4o-miniが内部データを読み込んで理解
   - 一般知識と社内情報を組み合わせて応答生成
   - 学習には使用されない（OpenAI API規約）

3. **組み合わせの具体例**
   ```
   [プロンプト]
   以下の社内情報を参考に、ユーザーの質問に回答してください。

   【社内情報】
   - 有給休暇の申請は人事システムから行う
   - 承認フローは直属上司→部門長の順

   【質問】
   [PERSON_001]さんの有給申請方法を教えてください
   ```

#### 直接的なアクション・追加プロンプトコマンドの起動

**❌ 以下の動作は実装していません**:
- 外部システムへの自動書き込み
- データベースの更新処理
- ファイルの自動作成・削除
- メール送信等の通知
- 追加のプロンプトコマンドの連鎖実行

**✅ 実装する機能**:
- 読み取り専用のデータ取得（Notion API）
- AI応答の生成のみ
- Slackへの返信のみ

#### ご理解の確認

> 「内部データと外部データを組み合わせて、直接的なアクションや
> 追加のプロンプトコマンドが起動されることはない」

**✅ その理解で正しいです**

- 内部データ（Notion）と外部データ（OpenAI）は応答生成にのみ使用
- 自動的なアクション実行はありません
- 追加のプロンプトコマンドの連鎖もありません

---

## データガバナンス・セキュリティ対策

### OpenAI APIのデータ利用ポリシー

| 項目 | 内容 |
|-----|-----|
| **学習利用** | API経由のデータは学習に使用されない |
| **データ保持** | デフォルトで30日後に自動削除 |
| **Zero Data Retention** | オプション設定で即時削除可能 |
| **データ所有権** | お客様に帰属 |

参考: [OpenAI API Data Usage Policies](https://openai.com/policies/api-data-usage-policies)

### 社内データの取り扱い方針

1. **Notion APIデータ**
   - メモリ上のみで処理（永続化しない）
   - 永続化する場合は暗号化必須

2. **会話履歴**
   - PIマスク後のデータのみ保存
   - ベクトルDB保存前にマスク処理

3. **監査ログ**
   - OpenAI送信内容をログ記録（マスク後のみ）
   - アクセスログ90日間保管
   - 定期的なセキュリティレビュー

### セキュリティ対策

| 対策 | 実装状況 |
|-----|---------|
| Slack署名検証 | ✅ 実装済み |
| TLS暗号化通信 | ✅ 実装済み |
| PIマスキング | ⏳ フェーズ2で実装 |
| 環境変数管理 | ✅ 実装済み |
| 監査ログ | ⏳ フェーズ6で実装 |
| アクセス制御 | ✅ Slack App権限で制御 |
| エラー時のPI漏洩防止 | ⏳ フェーズ6で実装 |

---

## コスト見積もり

### OpenAI API利用コスト

| サービス | 単価 | 想定利用量 | 月額 |
|---------|-----|----------|-----|
| GPT-4o-mini | $0.15/1M入力<br>$0.60/1M出力 | 10,000リクエスト<br>(平均500トークン/リクエスト) | $50-100 |
| Embeddings | $0.02/1M tokens | 1,000埋め込み生成/日 | $10-20 |

**合計想定コスト**: $60-120/月

### その他インフラコスト

- ベクトルDB: $0-70/月（PostgreSQL自社 or Pinecone）
- ホスティング: $20-50/月（Vercel等）

**総合計**: $80-240/月

---

## リスク管理

### リスクと対策

| リスク | 影響度 | 対策 |
|-------|-------|-----|
| **OpenAIへのPI送信** | 高 | フェーズ2でPIマスキング必須実装 |
| **Notion認証情報漏洩** | 高 | 環境変数管理、最小権限の原則 |
| **RAGレイテンシ** | 中 | キャッシング、並列処理 |
| **コスト超過** | 中 | リクエスト数制限、トークン数制限 |

---

## 実装スケジュール

| フェーズ | 内容 | 期間 |
|---------|-----|-----|
| ✅ フェーズ1 | 基本Slackbot機能 | 完了 |
| ⏳ フェーズ2 | **PIマスキング機能** | 2週間 |
| ⏳ フェーズ3 | Notion API連携 | 1週間 |
| ⏳ フェーズ4 | RAGシステム構築 | 2週間 |
| ⏳ フェーズ5 | 会話履歴管理 | 1週間 |
| ⏳ フェーズ6 | セキュリティ強化 | 1週間 |

**OpenAI APIキー申請のタイミング**: フェーズ2（PIマスキング）実装前に申請し、実装完了後に本番運用開始

---

## 添付資料

- `MIGRATION_PLAN.md`: 詳細な移行計画
- `CLAUDE.md`: プロジェクト概要
- 現在のソースコード（GitHub等）

---

## 連絡先

ご質問がございましたら、以下までお問い合わせください。

- 担当者: [お名前]
- メール: [メールアドレス]
- Slack: [Slackハンドル]

---

**最終更新日**: 2025-12-12
